% Repository GPM - Gaussian Preintegrated Measurements
% This code is released under the MIT License.
% Copyright 2020 Cedric Le Gentil
% 
% Jacobian of the S0(3) exponential mapping
function [ jacobian ] = ExpMapJacobian( axis_angle )

    length_mat = size(axis_angle,3);
    r1 = reshape(axis_angle(1,1,:),1,[]);
    r2 = reshape(axis_angle(2,1,:),1,[]);
    r3 = reshape(axis_angle(3,1,:),1,[]);

    jacobian = reshape([...
                                                                                                                                                                                           - (r1.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)).*(r2.^2 + r3.^2))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - (2.*r1.*(r2.^2 + r3.^2).*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
         (r1.*r3.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) - (r2.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) - (r1.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (r1.^2.*r2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r1.^2.*r2.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
         (r1.*r2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - (r1.*r2.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) - (r3.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) + (r1.^2.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r1.^2.*r3.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
         (r1.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - (r1.*r3.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) - (r2.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) + (r1.^2.*r2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r1.^2.*r2.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
                                                                                                                         (2.*r1.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) - (r1.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)).*(r1.^2 + r3.^2))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - (2.*r1.*(r1.^2 + r3.^2).*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
              sin((r1.^2 + r2.^2 + r3.^2).^(1./2))./(r1.^2 + r2.^2 + r3.^2).^(1./2) - (r1.^2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (r1.^2.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) + (r1.*r2.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r1.*r2.*r3.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
         (r1.*r2.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) - (r3.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) - (r1.*r2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (r1.^2.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r1.^2.*r3.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
              (r1.^2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - sin((r1.^2 + r2.^2 + r3.^2).^(1./2))./(r1.^2 + r2.^2 + r3.^2).^(1./2) - (r1.^2.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) + (r1.*r2.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r1.*r2.*r3.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
                                                                                                                         (2.*r1.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) - (r1.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)).*(r1.^2 + r2.^2))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - (2.*r1.*(r1.^2 + r2.^2).*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
                                                                                                                         (2.*r2.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) - (r2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)).*(r2.^2 + r3.^2))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - (2.*r2.*(r2.^2 + r3.^2).*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
         (r2.*r3.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) - (r1.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) - (r2.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (r1.*r2.^2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r1.*r2.^2.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
              (r2.^2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - sin((r1.^2 + r2.^2 + r3.^2).^(1./2))./(r1.^2 + r2.^2 + r3.^2).^(1./2) - (r2.^2.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) + (r1.*r2.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r1.*r2.*r3.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
         (r2.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - (r2.*r3.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) - (r1.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) + (r1.*r2.^2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r1.*r2.^2.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
                                                                                                                                                                                           - (r2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)).*(r1.^2 + r3.^2))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - (2.*r2.*(r1.^2 + r3.^2).*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
         (r1.*r2.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) - (r3.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) - (r1.*r2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (r2.^2.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r2.^2.*r3.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
              sin((r1.^2 + r2.^2 + r3.^2).^(1./2))./(r1.^2 + r2.^2 + r3.^2).^(1./2) - (r2.^2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (r2.^2.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) + (r1.*r2.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r1.*r2.*r3.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
         (r1.*r2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - (r1.*r2.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) - (r3.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) + (r2.^2.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r2.^2.*r3.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
                                                                                                                         (2.*r2.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) - (r2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)).*(r1.^2 + r2.^2))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - (2.*r2.*(r1.^2 + r2.^2).*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
                                                                                                                         (2.*r3.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) - (r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)).*(r2.^2 + r3.^2))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - (2.*r3.*(r2.^2 + r3.^2).*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
              sin((r1.^2 + r2.^2 + r3.^2).^(1./2))./(r1.^2 + r2.^2 + r3.^2).^(1./2) - (r3.^2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (r3.^2.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) + (r1.*r2.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r1.*r2.*r3.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
         (r2.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - (r2.*r3.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) - (r1.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) + (r1.*r3.^2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r1.*r3.^2.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
              (r3.^2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - sin((r1.^2 + r2.^2 + r3.^2).^(1./2))./(r1.^2 + r2.^2 + r3.^2).^(1./2) - (r3.^2.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) + (r1.*r2.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r1.*r2.*r3.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
                                                                                                                         (2.*r3.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) - (r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)).*(r1.^2 + r3.^2))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - (2.*r3.*(r1.^2 + r3.^2).*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
         (r1.*r3.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) - (r2.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) - (r1.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (r2.*r3.^2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r2.*r3.^2.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
         (r2.*r3.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) - (r1.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) - (r2.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (r1.*r3.^2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r1.*r3.^2.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
         (r1.*r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - (r1.*r3.*cos((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2) - (r2.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2) + (r2.*r3.^2.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)))./(r1.^2 + r2.^2 + r3.^2).^(3./2) + (2.*r2.*r3.^2.*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2;...
                                                                                                                                                                                           - (r3.*sin((r1.^2 + r2.^2 + r3.^2).^(1./2)).*(r1.^2 + r2.^2))./(r1.^2 + r2.^2 + r3.^2).^(3./2) - (2.*r3.*(r1.^2 + r2.^2).*(cos((r1.^2 + r2.^2 + r3.^2).^(1./2)) - 1))./(r1.^2 + r2.^2 + r3.^2).^2 ...
        ], 9,3,[]);

    
    mask = sum(sum(isnan(jacobian),1),2) ~= 0;
    
    if sum(mask) ~= 0
        jacobian(:,:,mask) = repmat([...
            [  0,  0,  0];...
            [  0,  0,  1];...
            [  0, -1,  0];...
            [  0,  0, -1];...
            [  0,  0,  0];...
            [  1,  0,  0];...
            [  0,  1,  0];...
            [ -1,  0,  0];...
            [  0,  0,  0]],1,1,sum(mask));
    end
    
    if length_mat == 1
        jacobian = reshape(jacobian, 9,3);
    end
    
end